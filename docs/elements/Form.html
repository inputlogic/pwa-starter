<!DOCTYPE html>

<html>
<head>
  <title>Form.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>Form.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="../consts.html">
                    consts.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="Form.html">
                    elements/Form.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="Header.html">
                    elements/Header.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="NotFound.html">
                    elements/NotFound.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/Helmet.html">
                    hoc/Helmet.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/ListResource.html">
                    hoc/ListResource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/Resource.html">
                    hoc/Resource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/Router.html">
                    hoc/Router.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/WithRequest.html">
                    hoc/WithRequest.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../hoc/WithState.html">
                    hoc/WithState.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../modals/ExampleModal.html">
                    modals/ExampleModal.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../routes.html">
                    routes.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../store.html">
                    store.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/equal.html">
                    util/equal.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/loadImage.html">
                    util/loadImage.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/makeRequest.html">
                    util/makeRequest.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/paginationRange.html">
                    util/paginationRange.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/qs.html">
                    util/qs.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/updateQuery.html">
                    util/updateQuery.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/urlFor.html">
                    util/urlFor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="../util/workerize.html">
                    util/workerize.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> makeRequest <span class="hljs-keyword">from</span> <span class="hljs-string">'/util/makeRequest'</span>

<span class="hljs-keyword">const</span> isReactNative = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.navigator.product === <span class="hljs-string">'ReactNative'</span></pre></div>
        
      
        
        <p>children can be an array or object in React,
but always array in Preact.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> compatMap = React.Children
  ? React.Children.map
  : <span class="hljs-function">(<span class="hljs-params">ls, fn</span>) =&gt;</span> <span class="hljs-built_in">Array</span>.prototype.map.call(ls, fn)</pre></div>
        
      
        
        <p>React method to skip textNodes, and Preact fallback.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> compatIsValid = React.isValidElement
  ? React.isValidElement
  : <span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.nodeName != <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>These are the component names that we will sync values
to our parent Form state.
@TODO: This should be props passed into <Form /></p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> formFieldNames = [</pre></div>
        
      
        
        <p>Our ReactNative ‘form’ components</p>

        
          <div class='highlight'><pre>  <span class="hljs-string">'InputIcon'</span>,
  <span class="hljs-string">'InputText'</span>
]

<span class="hljs-keyword">const</span> getNodeName = <span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span>
  child.type ? child.type.displayName : child.nodeName.name

<span class="hljs-keyword">const</span> getProps = <span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.attributes || child.props || {}</pre></div>
        
      
        
        <p>Is one of the above defined form fields, and has a <code>name</code>
prop set. We can’t sync state if the component doesn’t have
have a <code>name</code> prop set.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">const</span> isFormField = <span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span>
  formFieldNames.includes(getNodeName(child)) &amp;&amp;
  getProps(child).name != <span class="hljs-literal">null</span>

<span class="hljs-comment">/**
 * Our Form Component
 *
 * Required Props:
 *
 *  name: A unique String identifer for your Form
 *
 * Optional Props:
 *
 *  initialData: An Object whose keys match formFieldNames and whose values will
 *  be set as defaults.
 *
 *  onSubmit: When the Form is submitted, this will be called with
 *  `{hasError, errors, data}`
 *
 * If you do not specify an `onSubmit` prop, you should specify a `action` and
 * optional `method` prop.
 *
 *  action: The URL to send the form data to.
 *  method: The HTTP method to use, defaults to POST.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Form</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-keyword">constructor</span> (props) {
    <span class="hljs-keyword">super</span>(props)
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.props.name) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'&lt;Form /&gt; Components needs a `name` prop.'</span>)
    <span class="hljs-keyword">this</span>.state = {
      <span class="hljs-attr">values</span>: <span class="hljs-keyword">this</span>.props.initialData || {},
      <span class="hljs-attr">errors</span>: {}
    }
    <span class="hljs-keyword">this</span>._fields = {}
  }

  _updateChildFormFields (children, formName) {
    <span class="hljs-keyword">return</span> compatMap(children, child =&gt; {
      <span class="hljs-keyword">if</span> (!compatIsValid(child)) {
        <span class="hljs-keyword">return</span> child
      }

      <span class="hljs-keyword">const</span> childProps = child.attributes || child.props
      <span class="hljs-keyword">if</span> (childProps.isSubmit) {</pre></div>
        
      
        
        <p>if has isSubmit flag, treat as Submit button on ReactNative</p>

        
          <div class='highlight'><pre>        child = React.cloneElement(child, {formName, <span class="hljs-attr">onPress</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>._onSubmit()})
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isFormField(child)) {</pre></div>
        
      
        
        <p>If one of our nested Form Fields, add syncState prop.
If not ReactNative, override the onChange event to sync value.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">const</span> newProps = {
          formName,
          <span class="hljs-attr">text</span>: <span class="hljs-keyword">this</span>.state.values[child.props.name],
          <span class="hljs-attr">syncState</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">values</span>: {
            ...this.state.values,
            [childProps.name]: state.value || state.text
          }})
        }
        <span class="hljs-keyword">if</span> (!isReactNative) {
          newProps.onChange = <span class="hljs-function"><span class="hljs-params">ev</span> =&gt;</span> <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">values</span>: {
            ...this.state.values,
            [childProps.name]: ev.target.value
          }})
        }
        child = React.cloneElement(child, newProps)</pre></div>
        
      
        
        <p>Store a reference to our fields, so we can validate them on submit</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>._fields[childProps.name] = child
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.children || child.props.children) {</pre></div>
        
      
        
        <p>Recursively search children for more form fields</p>

        
          <div class='highlight'><pre>        child = React.cloneElement(child, {
          formName,
          <span class="hljs-attr">children</span>: <span class="hljs-keyword">this</span>._updateChildFormFields(
            child.children || child.props.children,
            formName
          )
        })
      }

      <span class="hljs-keyword">return</span> child
    })
  }

  _onSubmit (ev) {
    ev &amp;&amp; ev.preventDefault()
    <span class="hljs-keyword">const</span> fieldNames = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>._fields)</pre></div>
        
      
        
        <p>@TODO: More validations, allow props to set them, etc.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">const</span> errors = fieldNames.reduce(<span class="hljs-function">(<span class="hljs-params">errs, name</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">this</span>._fields[name]
      <span class="hljs-keyword">if</span> (getProps(comp).required &amp;&amp; !<span class="hljs-keyword">this</span>.state.values[name]) {
        errs[name] = <span class="hljs-string">'Is required.'</span>
      }
      <span class="hljs-keyword">return</span> errs
    }, {})

    <span class="hljs-keyword">const</span> hasError = <span class="hljs-built_in">Object</span>.keys(errors).length &gt; <span class="hljs-number">0</span>
    hasError &amp;&amp; <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">errors</span>: {...this.state.errors, ...errors}})

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.props.onSubmit) {
      <span class="hljs-keyword">this</span>.props.onSubmit({
        hasError,
        <span class="hljs-attr">errors</span>: errors,
        <span class="hljs-attr">data</span>: <span class="hljs-keyword">this</span>.state.values
      })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> {xhr, promise} = makeRequest({
        <span class="hljs-attr">endpoint</span>: <span class="hljs-keyword">this</span>.props.action,
        <span class="hljs-attr">method</span>: <span class="hljs-keyword">this</span>.props.method || <span class="hljs-string">'post'</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-keyword">this</span>.state.values
      })
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'makeRequest'</span>, <span class="hljs-keyword">this</span>.state.values)
      promise
        .then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-keyword">this</span>.props.onSuccess &amp;&amp; <span class="hljs-keyword">this</span>.props.onSuccess(r))
        .catch(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-keyword">this</span>.props.onFailure &amp;&amp; <span class="hljs-keyword">this</span>.props.onFailure(xhr))
    }
  }

  render () {
    <span class="hljs-keyword">const</span> children = <span class="hljs-keyword">this</span>._updateChildFormFields(
      <span class="hljs-keyword">this</span>.children || <span class="hljs-keyword">this</span>.props.children,
      <span class="hljs-keyword">this</span>.props.name
    )
    <span class="hljs-keyword">return</span> isReactNative
      ? children
      : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">Form-</span>${<span class="hljs-attr">this.props.name</span>}`}
        <span class="hljs-attr">key</span>=<span class="hljs-string">{this.props.name}</span>
        <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{this._onSubmit.bind(this)}</span>
      &gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
