<!DOCTYPE html>

<html>
<head>
  <title>store.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>store.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="consts.html">
                    consts.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elements/Form.html">
                    elements/Form.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elements/Header.html">
                    elements/Header.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elements/NotFound.html">
                    elements/NotFound.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/Apps.html">
                    hoc/Apps.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/Helmet.html">
                    hoc/Helmet.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/ListResource.html">
                    hoc/ListResource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/Resource.html">
                    hoc/Resource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/Router.html">
                    hoc/Router.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/WithRequest.html">
                    hoc/WithRequest.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="hoc/WithState.html">
                    hoc/WithState.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="modals/ExampleModal.html">
                    modals/ExampleModal.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="routes.html">
                    routes.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="store.html">
                    store.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/equal.html">
                    util/equal.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/loadImage.html">
                    util/loadImage.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/makeRequest.html">
                    util/makeRequest.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/paginationRange.html">
                    util/paginationRange.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/qs.html">
                    util/qs.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/updateQuery.html">
                    util/updateQuery.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/urlFor.html">
                    util/urlFor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="util/workerize.html">
                    util/workerize.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-keyword">import</span> {DEBUG} <span class="hljs-keyword">from</span> <span class="hljs-string">'/consts'</span></pre></div>
        
      
        
        <p>PWA-Starter uses a very basic <em>store</em> for global state.
Any time you need to share state outside of a single Component,
you can use this <code>/store.js</code>.</p>

        
      
        
        <p>We don’t use Redux. We found actions and reducers introduced complexity
and boilerplate, that was not necessary, even for large projects.</p>

        
      
        
        <p>First we define our inital state object.</p>

        
          <div class='highlight'><pre>
<span class="hljs-keyword">const</span> state = {</pre></div>
        
      
        
        <p>In the browser, we initialize the currentPath prop, which is used
by our <a href="/hoc/Router.html">Router</a></p>

        
          <div class='highlight'><pre>  currentPath: <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>
    ? <span class="hljs-built_in">window</span>.location.pathname + <span class="hljs-built_in">window</span>.location.search
    : <span class="hljs-string">'/'</span>,</pre></div>
        
      
        
        <p><code>pendingRequests</code> is used by the <a href="/hoc/WithRequest.html">WithRequest</a> HoC.</p>

        
          <div class='highlight'><pre>  pendingRequests: <span class="hljs-number">0</span>,</pre></div>
        
      
        
        <p>Server-side rendering will have already computed some
values for global state, and should be initialized on the client.
This avoids redoing initial logic that was just computed on the server.</p>

        
          <div class='highlight'><pre>  ...(<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span>
      ? <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">window</span>.__initial_store__ || <span class="hljs-string">''</span>)
      : {})
}</pre></div>
        
      
        
        <p>This is a private reference to Component instances that will be updated
after every <code>setState</code>.</p>

        
          <div class='highlight'><pre>
<span class="hljs-keyword">const</span> components = []</pre></div>
        
      
        
        <p>Instead of passing in functions to call when state is changed, we pass in
Component instances. The easiest way to do so is in a Component’s contructor:</p>

        
      
        
        <p><code>this.state = subscribe(this)</code></p>

        
      
        
        <p>this adds the Component instance to the array of components to update on state
changes, and returns the current state to set as the Component state. This makes
for very fast prototyping, and when needed, you can implement <code>shouldComponentUpdate</code>
logic on your Component to improve performance.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> subscribe = <span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
  components.push(component)
  <span class="hljs-keyword">return</span> getState()
}</pre></div>
        
      
        
        <p>If you subscribe a Component instance, you need to remove it when the Component
is being destoyed:</p>

        
      
        
        <pre><code>componentWillUnmount () {
  unsubscribe(<span class="hljs-keyword">this</span>)
}</code></pre>
        
      
        
        <p><code>unsubscribe</code> simply removes the component from the local components array.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> idx = components.findIndex(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c === component)
  idx &gt; <span class="hljs-number">-1</span> &amp;&amp; components.splice(idx, <span class="hljs-number">1</span>)
}</pre></div>
        
      
        
        <p><code>getState</code> returns the current state. <code>Object.freeze</code> is used, to return
an immutable copy of the state object. Well, almost. It’s only a shallow
immutable copy. You should avoid mutations on nested objects and arrays,
as they will sync back to the global state. For now, I figure PRs can
catch this misuse. But, if it proves a problem, then a deep <code>Object.freeze</code>
could be implemented.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getState = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">Object</span>.freeze({...state})</pre></div>
        
      
        
        <p>Just like React <code>setState</code>. If <code>DEBUG</code> is true, will log to console. And, of
course, it will iterate the subscribed components and call <code>component.setState</code>
on each of them.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> setState = <span class="hljs-function"><span class="hljs-params">updatedState</span> =&gt;</span> {
  <span class="hljs-built_in">Object</span>.assign(state, updatedState)
  DEBUG &amp;&amp; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'setState'</span>, updatedState, state)
  components.forEach(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.setState(state))
}</pre></div>
        
      
        
        <p>And lastly, a helper to change state on click events. Often used on <code>&lt;button /&gt;</code>‘s.</p>

        
      
        
        <p><code>&lt;button onClick={clickState(state =&gt; ({clicks: state.clicks + 1}))}&gt;Click Me&lt;/button&gt;</code></p>

        
          <div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> clickState = <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> ev =&gt; {
  ev.preventDefault()
  setState(
    <span class="hljs-keyword">typeof</span> state === <span class="hljs-string">'function'</span>
      ? state(getState(), ev)
      : state
  )
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
